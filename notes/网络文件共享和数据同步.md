网络文件共享服务和数据同步

> 鸟哥的Linux私房菜 服务器架设篇 第三版 第13章 文件服务器之一：NFS 服务器


# 存储类型
> [NAS vs SAN - Network Attached Storage vs Storage Area Network](https://www.youtube.com/watch?v=3yZDDr0JKVc&ab_channel=PowerCertAnimatedVideos)


## 直连式存储 DAS
- PC 中的硬盘或只有一个外部 SCSI 接口的硬盘簇（JBOD, just a bunch of disks）
- DAS 指存储设备直接连接到服务器的总线上，存储设备只与一台独立的主机连接，其他主机不能使用这个存储设备
- DAS 存储设备与服务器主机之间的连接通道通常采用 SCSI 连接

## 网络附加存储 NAS
- 存储设备通过标准的网络拓扑结构添加到一群计算机上
- NAS 是文件级的存储方法，多用来进行文件共享
- 即插即用，一般支持多台计算机，用户通过网络协议访问文档

缺点：
- NAS 备份过程中消耗网络带宽


## 存储区域网络 SAN
- 通过光纤通道或以太网交换机连接存储阵列和服务器主机，称为一个专用的存储网络
- 允许任何服务器连接任何存储阵列
- 可扩展性好
- 高可用性
- 适合大型应用或数据库系统

缺点：
- 成本高
- 复杂





# NFS
- network file system，网络文件系统，基于内核的文件系统
- 可以通过网络，让不同的机器、不同的操作系统可以共享彼此的文件
- 对于用户来说，远程主机的文件就好像自己的一个磁盘分区一样
- NFS 用来传输数据的端口号是随机选择的，小于 1024 的端口
- 客户端通过远程过程调用（remote procedure call，RPC）协议来获取 NFS 服务器的端口号


# RPC 
- remote procedure call，远程过程调用
- 因为 NFS 支持的功能太多，不同的功能会使用不同的程序启动，每启动一个程序就会用到一些端口
因此，NFS 的功能所对应的端口不固定，而是随机选择一些未被使用的端口用于传输
- NFS 服务端启动程序后会选择端口，并主动向 RPC 注册，因此 RPC 知道 NFS 服务程序使用的端口
- RPC 的主要功能是告知客户端 NFS 服务端已注册的端口
- 客户端和服务端都要启动 RPC

# NFS 软件安装

1. 安装 NFS 主程序
- rocky8.6
```bash
root@Rocky8 ~ $ yum install nfs-utils
```
包含服务端和客户端包

- ubuntu22.04
服务端包：
```bash
[root@ubuntu2204 ~]$ apt install nfs-kernel-server
```

客户端包：
```bash
[root@ubuntu2204 ~]$ apt install nfs-common
```

```bash
[root@ubuntu2204 ~]$ systemctl status nfs-server.service
● nfs-server.service - NFS server and services
     Loaded: loaded (/lib/systemd/system/nfs-server.service; enabled; vendor preset: enabled)
     Active: active (exited) since Wed 2023-09-13 21:59:43 CST; 2min 22s ago
   Main PID: 6439 (code=exited, status=0/SUCCESS)
        CPU: 7ms

Sep 13 21:59:43 ubuntu2204 systemd[1]: Starting NFS server and services...
Sep 13 21:59:43 ubuntu2204 exportfs[6438]: exportfs: can't open /etc/exports for reading
Sep 13 21:59:43 ubuntu2204 systemd[1]: Finished NFS server and services.
[root@ubuntu2204 ~]$ cat /proc/fs/nfsd/versions
-2 +3 +4 +4.1 +4.2
```

2. 安装 RPC 主程序 rpcbind
安装完 NFS 主程序后查看，已有则不用再安装

3. 安装后启动服务
查看 nfs-server 和 rpcbind 两个服务，每有启动则启动
```bash
[root@ubuntu2204 ~]$ systemctl status nfs-server.service
[root@ubuntu2204 ~]$ systemctl status rpcbind.service
```

# NFS 启动的主要进程
NFS 服务器启动时要向 RPC 注册，因此 NFS 服务器也称为 RPC Server 之一
NFS 服务器需要进行文件系统的共享，文件系统的共享与权限有关，因此 NFS 服务器启动至少需要两个 daemons:
- 管理客户端能否登录
- 管理客户端能取得的权限

## rpc.nfsd
最主要的 NFS 进程，管理客户端能否登录

## rpc.mounted
管理 NFS 文件系统，在用户登录后，经过权限认证
该程序会读 NFS 的配置文件 /etc/exports 来对比客户端的权限

也用来挂载和卸载 NFS 文件系统

## rpc.locked
非必要
管理文件的锁定，避免同时写文件
必须服务端与客户端均启用才生效

## rpc.statd
非必要
检查文件的一致性，与 rpc.locked 有关
如果客户端同时使用文件造成损坏时，rpc.statd 可以用来检测并尝试修复该文件
必须服务端与客户端均启用才生效


# NFS 软件结构
- NFS 直接使用内核功能，内核必须支持 NFS

## 主要配置文件
- /etc/exports

```bash
# /etc/exports: the access control list for filesystems which may be exported
#		to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
```
配置文件格式见说明文档，或者 `man 5 exports`

远程用户访问 NFS 服务器时，服务器进行权限等判断时看的是客户端用户的 uid 和 gid，而非用户名和组名

- 注释以 `#` 开头

- 共享目录 第一个主机(权限) 第二个主机(权限)
权限参数以逗号间隔

- 主机名的格式
  - ip
  10.0.0.200
  - 网段 
  10.0.0.0/24 或 10.0.0.0/255.255.255.0
  - 主机名
  主机名要在 /etc/hosts 中解析
  - 通配符
  * 表示所有主机

- 权限参数
  - rw, ro 
  读写，只读
  - sync, async
  同步写入磁盘，异步写入磁盘（先缓存在内存中，稍后再写入磁盘）
  - root_squash, no_root_squash
  root_squash 则远程客户端 root 用户访问时身份压缩为匿名用户 nobody（不同系统版本可能不同，匿名用户，具体查看帮助说明）
  no_root_squash 则远程客户端 root 用户访问 NFS 服务器还是以 root 身份，不压缩
  - all_squash
  所有远程访问的用户，其身份都被压缩为匿名用户 nobody (rocky8.6)
  - anonuid, anongid
  anon 指 anonymous，可以将远程访问的用户压缩成知道的用户，而非默认的匿名用户，可配合 all_squash 使用


## NFS 文件系统维护命令 exportfs
- /usr/sbin/exportfs
- 主要用作服务端

## 共享资源的日志
- /etc/lib/nfs/
```bash
[root@ubuntu2204 ~]$ ls /var/lib/nfs/
etab  export-lock  nfsdcld  rmtab  sm  sm.bak  state  v4recovery
```

## 客户端查询服务器共享资源的命令 showmount
- /usr/sbin/showmount
- 主要用在客户端


NFS 服务器在客户端之后启动，客户端不会自动挂载
```bash
/home/joe       pc001(rw,all_squash,anonuid=150,anongid=100)

```

两个 web 服务：10.0.0.203 和 10.0.0.204 :
安装web 服务：
[How To Install the Apache Web Server on Ubuntu 22.04](https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-22-04)

```bash
[root@Web2 data]$ apt install -y apache2

[root@Web2 data]$ ufw status
Status: inactive

```

```bash
[root@Web2 html]$ systemctl status apache2.service
● apache2.service - The Apache HTTP Server
     Loaded: loaded (/lib/systemd/system/apache2.service; enabled; vendor preset: enabled)
     Active: active (running) since Sun 2023-05-14 15:06:32 CST; 11min ago
       Docs: https://httpd.apache.org/docs/2.4/
    Process: 54259 ExecStart=/usr/sbin/apachectl start (code=exited, status=0/SUCCESS)
   Main PID: 54263 (apache2)
      Tasks: 7 (limit: 2193)
     Memory: 10.9M
        CPU: 153ms
     CGroup: /system.slice/apache2.service
             ├─54263 /usr/sbin/apache2 -k start
             ├─54267 /usr/sbin/apache2 -k start
             ├─54268 /usr/sbin/apache2 -k start
             ├─54269 /usr/sbin/apache2 -k start
             ├─54270 /usr/sbin/apache2 -k start
             ├─54271 /usr/sbin/apache2 -k start
             └─54747 /usr/sbin/apache2 -k start

May 14 15:06:31 Web2 systemd[1]: Starting The Apache HTTP Server...
May 14 15:06:32 Web2 apachectl[54262]: AH00558: apache2: Could not reliably determine the server's fully qualifi>
May 14 15:06:32 Web2 systemd[1]: Started The Apache HTTP Server.
[root@Web2 html]$
```
```bash
[root@Web2 html]$ ps aux | grep apache2
www-data   46083  0.0  0.0   3736   160 ?        Ss   15:04   0:00 /usr/bin/htcacheclean -d 120 -p /var/cache/apache2/mod_cache_disk -l 300M -n
root       54263  0.0  0.9 206360 19736 ?        Ss   15:06   0:00 /usr/sbin/apache2 -k start
www-data   54267  0.0  0.4 206852  8980 ?        S    15:06   0:00 /usr/sbin/apache2 -k start
www-data   54268  0.0  0.4 206868  8980 ?        S    15:06   0:00 /usr/sbin/apache2 -k start
www-data   54269  0.0  0.4 206852  8980 ?        S    15:06   0:00 /usr/sbin/apache2 -k start
www-data   54270  0.0  0.4 206852  8980 ?        S    15:06   0:00 /usr/sbin/apache2 -k start
www-data   54271  0.0  0.5 206916 10676 ?        S    15:06   0:00 /usr/sbin/apache2 -k start
www-data   54747  0.0  0.4 206852  8980 ?        S    15:09   0:00 /usr/sbin/apache2 -k start
root       57152  0.0  0.1   9564  2356 pts/1    S+   15:19   0:00 grep --color=auto apache2
```
web 服务 owner 为 www-data

```bash
[root@Web2 html]$ id www-data
uid=33(www-data) gid=33(www-data) groups=33(www-data)
[root@Web2 html]$ getent passwd 33
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
[root@Web2 html]$
[root@Web2 html]$ getent passwd lx
lx:x:1001:1001::/home/lx:/bin/bash
```


NFS 服务器 rocky8.6 10.0.0.83 
rocky 上已经有 tape（33）组，暂时将其该名为 www-data，该组没有用户使用
```bash
[root@NFS html]$ getent group 33
tape:x:33:
[root@NFS html]$ vim /etc/group
[root@NFS html]$ man group
(reverse-i-search)`useradd': ^Ceradd -u 33 -g 33 -d /var/www -s /bin/nologin -r www-data
[root@NFS html]$ useradd -u 33 -g 33 -d /var/www -s /bin/nologin -r www-data^C
[root@NFS html]$ useradd -u 33 -g 33 -d /var/www -s /bin/nologin -r www-data
[root@NFS html]$ id 33
uid=33(www-data) gid=33(tape) groups=33(tape)
[root@NFS html]$ groupmod -n www-data tape
[root@NFS html]$ id 33
uid=33(www-data) gid=33(www-data) groups=33(www-data)
[root@NFS html]$
```

***********
LVS 10.0.0.202 ubuntu 22.04


router 
开启 ip_forward
```bash
[root@lvs netplan]$ vim /etc/sysctl.conf
[root@lvs netplan]$ sysctl -p
net.ipv4.ip_forward = 1
[root@lvs netplan]$ cat /proc/sys/net/ipv4/ip_forward
1
```

```bash
route add -net 192.168.10.0/24 gw 172.16.18.2 dev eth1
```

```bash
 This is a complex example which shows most available features:

              network:
                version: 2
                # if specified, can only realistically have that value, as networkd cannot
                # render wifi/3G.
                renderer: NetworkManager
                ethernets:
                  # opaque ID for physical interfaces, only referred to by other stanzas
                  id0:
                    match:
                      macaddress: 00:11:22:33:44:55
                    wakeonlan: true
                    dhcp4: true
                    addresses:
                      - 192.168.14.2/24
                      - 192.168.14.3/24
                      - "2001:1::1/64"
                    nameservers:
                      search: [foo.local, bar.local]
                      addresses: [8.8.8.8]
                    routes:
                      - to: default
                        via: 192.168.14.1
                      - to: default
                        via: "2001:1::2"
                      - to: 0.0.0.0/0
                        via: 11.0.0.1
                        table: 70
                        on-link: true
                        metric: 3
                    routing-policy:
                      - to: 10.0.0.0/8
                        from: 192.168.14.2/24
                        table: 70
                        priority: 100
                      - to: 20.0.0.0/8
                        from: 192.168.14.3/24
                        table: 70
                        priority: 50
                    # only networkd can render on-link routes and routing policies
                    renderer: networkd
                  lom:
                    match:
                      driver: ixgbe
                    # you are responsible for setting tight enough match rules
                    # that only match one device if you use set-name
                    set-name: lom1
                    dhcp6: true
                  switchports:
                    # all cards on second PCI bus unconfigured by
                    # themselves, will be added to br0 below
                    match:
                      name: enp2*
                    mtu: 1280
 wifis:
                  all-wlans:
                    # useful on a system where you know there is
                    # only ever going to be one device
                    match: {}
                    access-points:
                      "Joe's home":
                        # mode defaults to "infrastructure" (client)
                        password: "s3kr1t"
                  # this creates an AP on wlp1s0 using hostapd
                  # no match rules, thus the ID is the interface name
                  wlp1s0:
                    access-points:
                      "guest":
                         mode: ap
                         # no WPA config implies default of open
                bridges:
                  # the key name is the name for virtual (created) interfaces
                  # no match: and set-name: allowed
                  br0:
                    # IDs of the components; switchports expands into multiple interfaces
                    interfaces: [wlp1s0, switchports]
                    dhcp4: true

```
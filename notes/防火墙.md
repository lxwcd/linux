Linux 防火墙  
  
# 学习资源  
> 鸟哥的Linux私房菜 服务器架设篇 第9章  
> [What is a Firewall?](https://www.youtube.com/watch?v=kDEX1HXybrU&ab_channel=PowerCertAnimatedVideos)  
  
# 防火墙  
- 定义一些有序的规则，并管理进入到网络内的主机数据包的一种机制  
- 限制某些服务的访问来源  
  如限制 FTP 服务只能在主机内使用，不对 Internet 开放  
  如限制主机仅接受客户端的 WWW 请求，其他服务都关闭  
- 切割出被信任与不被信任的网段  
- 划分出可提供 Internet 的服务与必须受保护的服务  
- 分析出可接受与不可接受的数据包状态  
  
## 防火墙实现方式分类  
### 硬件防火墙  
- 厂商设计好的主机硬件  
- 硬件防火墙的操作系统主要用来提供数据包的数据过滤机制  
- 去掉不必要的功能，单纯作为防火墙使用  
  
### 软件防火墙  
- 保护系统网络安全的一套软件（或机制）  
- 如 Netfilter 与 TCP Wrapper   
  
  
## Linux 防火墙管理范围分类  
### 单一主机型  
- 数据包过滤型的 Netfilter  
- 依据服务软件程序作为分析的 TCP Wrapper  
  
### 网络型  
> [2.4.4 网络防火墙与 OSI 七层协定](http://cn.linux.vbird.org/linux_server/0110network_basic_4.php#tcpip_transfer_firewall)  
  
- 数据包过滤型的 Netfilter  
- 利用代理服务器（Proxy Server）进行访问  
  
  
## 防火墙的使用限制  
- 不能有效阻挡病毒或木马程序  
- 不能阻止来自内部的攻击  
  
  
## 防火墙的一般网路布线  
> [9.1.4 防火墙的一般网络布线示意](http://cn.linux.vbird.org/linux_server/0250simple_firewall_1.php#firewall_topo)  
  
  
# TCP Wrapper（程序管理）  
> [第九章、防火墙与 NAT 服务器](http://cn.linux.vbird.org/linux_server/0250simple_firewall_2.php)  
  
- 通过服务器程序的外挂（tcpd）来抵挡数据包的进入  
- 分析谁对某程序访问，然后通过规则分析该服务器程序能让谁连接  
- 主要通过分析服务器程序来管理，与启动的端口无关，只与程序名有关  
  
  
# Proxy（代理服务器）  
> [Proxy server](https://en.wikipedia.org/wiki/Proxy_server)  
  
- 网络服务，代理用户的需求，代服务器取得相关资料  
  
  
# Netfilter 数据包过滤机制  
> [netfilter](https://netfilter.org/documentation/)  
  
  
- 将数据包的头部信息提取处理进行分析  
- 一般处理的为 OSI 七层模型的 2、3、4 层  
- Linux 中使用**内核内建**了 Netfilter 这个机制  
- Netfilter 提供了 iptables 这个**软件**来作为防火墙数据包过滤的命令  
- 因为 Netfilter 是内核内建的功能，因此效率高，适合一般小型环境的设置  
  
  
> [Netfilter](https://en.wikipedia.org/wiki/Netfilter)  
> &nbsp;  
> Netfilter is a framework provided by the Linux kernel that allows various networking-related operations to be implemented in the form of customized handlers.   
> Netfilter offers various functions and operations for packet filtering, network address translation, and port translation, which provide the functionality required for directing packets through a network and prohibiting packets from reaching sensitive locations within a network.  
> Netfilter represents a set of hooks inside the Linux kernel, allowing specific kernel modules to register callback functions with the kernel's networking stack.   
> Those functions, usually applied to the traffic in the form of filtering and modification rules, are called for every packet that traverses the respective hook within the networking stack.  
  
- Netfilter Linux 内核提供的一个框架，允许各种网络相关的自定义操作  
- 模块化设计，好的扩展性  
  
  
## Netfilter 的 5 个 hooks  
> [What is meant by the term "hook" in programming?](https://stackoverflow.com/questions/467557/what-is-meant-by-the-term-hook-in-programming)  
> [How Function Hooking / Detouring Works](https://www.youtube.com/watch?v=b1ahj347pDc&ab_channel=Zer0Mem0ry)  
> [In-depth understanding of netfilter and iptables](https://www.sobyte.net/post/2022-04/understanding-netfilter-and-iptables/)  
  
  
- PREROUTING  
- INPUT  
- FORWARD  
- OUTPUT  
- POSROUTING  
  
  
- 5 个勾子函数对用户开放，用户可以通过命令工具 iptables 向其写入规则  
  
  
## 查看内核中 netfilter 相关模块  
```bash  
[root@rocky8-3 ~]$ grep -in netfilter /boot/config-$(uname -r)  
1099:CONFIG_NETFILTER=y  
1100:CONFIG_NETFILTER_ADVANCED=y  
1101:CONFIG_BRIDGE_NETFILTER=m  
1104:# Core Netfilter Configuration  
1106:CONFIG_NETFILTER_INGRESS=y  
1107:CONFIG_NETFILTER_NETLINK=m  
```  
  
# iptables - Linux 数据包过滤软件  
- 不同内核版本使用的防火墙软件不同  
- iptables 制定规则的顺序很重要  
- 当前面的规则满足就不会理会后面的规则  
- 使用 iptabls 设置防火墙时最好关闭本机的 firewalld 服务，因为两者都是制定防火墙规则，可能冲突  
- 需要 root 设置规则  
- 设置规则时注意不要让自己无法连接上（远程）  
例如虚拟机中使用 NAT 模式，则 windows 中有一个 VMnet8 的虚拟交换机，其地址为 10.0.0.1  
设置白名单规则，拒绝 10.0.0.0/24 网段中除了 10.0.0.82 以外的主机时要先允许 10.0.0.1，否则远程无法连接  
```bash  
[root@rocky8-3 ~]$ iptables -vnL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1      168 13928 ACCEPT     all  --  *      *       10.0.0.1             0.0.0.0/0  
2        0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0  
3       12   810 ACCEPT     all  --  *      *       10.0.0.82            0.0.0.0/0  
4      331 47058 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable  
```  
  
  
## iptables 的表（table）和链（chain）  
> [Linux Firewall Tutorial: IPTables Tables, Chains, Rules Fundamentals](https://www.thegeekstuff.com/2011/01/iptables-fundamentals/)  
> [A Deep Dive into Iptables and Netfilter Architecture](https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture)  
> [iptables](https://wiki.archlinux.org/title/iptables)  
> [iptables(8)](https://man.archlinux.org/man/iptables.8)  
  
  
- iptables 这个防火墙软件里有很多表（table）  
- 每个表都定义出自己的默认策略与规则  
- 每个表的用途都不同  
- iptables 由众多表（table）组成，每个表中有多个链（chain），而链（chain）中定义策略（policy）和规则（rule）  
- chain 中默认没有 rule，需要用户自己添加  
- chain 中有默认的 policy，通常为 ACCEPT  
  
- 表的优先级由高到低为：security, raw, mangle, nat, filter  
  
### Filter 表  
- 默认表  
- 与进入本机的数据包有关  
  
内置链：  
- INPUT  
与想进入本机的数据包有关  
- OUTPUT  
与本机发送出去的数据包有关  
- FORWARD  
与 NAT 表相关  
  
  
### NAT 表  
- 网络地址转换（Network Address Translation）  
  
内置链：  
- PREROUTING  
路由判决前要进行的规则（DNAT/REDIRECT）  
- OUTPUT  
与本机发送出去的数据包有关  
- POSTROUTING  
路由判决后所要进行的规则（SNAT/MASQUERADE）  
  
### Mangle 表  
> [A Deep Dive into Iptables and Netfilter Architecture](https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture)  
  
- 与特殊的数据包的路由标识有关  
- 修改数据标记位  
- 可以用来给数据包打标记  
This table can also place an internal kernel “mark” on the packet for further processing in other tables and by other networking tools.   
This mark does not touch the actual packet, but adds the mark to the kernel’s representation of the packet.  
  
内置链：  
- PREROUTING   
- INPUT   
- FORWARD   
- OUTPUT   
- POSTROUTING   
  
### Raw 表  
> [iptables](https://wiki.archlinux.org/title/iptables)  
  
- 关闭启用的连接跟踪机制，加快穿越防火墙的速度  
- raw is used only for configuring packets so that they are exempt from connection tracking  
- 如扩展模块中的 state 模块跟踪状态，如果在 raw 表中定义了关闭连接跟踪的规则，则不会跟踪  
  
内置链：  
- OUTPUT   
- POSTROUTING   
  
### Security 表  
- security is used for [Mandatory Access Control](https://wiki.archlinux.org/title/Security#Mandatory_access_control) networking rules   
- 由 SELinux 实现  
  
  
## 数据包过滤流程  
> [2.4 Traversing Chains](https://wiki.archlinux.org/title/iptables#Traversing_Chains)  
> [9.3.3 iptables 的表格 (table) 与链 (chain)](http://cn.linux.vbird.org/linux_server/0250simple_firewall_3.php#netfilter_chain)  
  
  
## iptables -nvL 看本机的防火墙规则  
- 注意先关闭 firewalld 服务  
- 虚拟机中关闭了防火墙规则后仍有一些规则存在，是因为 KVM 启动的，可以卸载  
```bash  
sudo yum remove qemu-kvm  
```  
  
> iptables [-t tables] [-L] [-nv]  
  
- `-L` 或 `--list` 列出链上的全部规则，不指定链则列出全部   
- `-t` 或 `--table` 指定查看的表，不写则列出全部表  
- `-n` 或 `--numeric`，写 IP 地址或端口而非名字  
- `-v` 或 `--verbose`，列出更详细的信息  
- 注意不能写 `iptables -Ln`，可以写 `iptables -nL` 或 `iptables -L -n`  
  
  
```bash  
[root@rocky8-3 ~]$ iptables -t filter vnL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1        0     0 DROP       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:21  
2        0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0  
3    10089  510K ACCEPT     all  --  eth0   *       10.0.0.0/24          0.0.0.0/0  
4        7   577 REJECT     all  --  *      *       10.0.0.151           0.0.0.0/0            reject-with icmp-port-unreachable  
```  
  
- num 规则编号  
- pkts 当前规则中，被命中的数据包数量  
- bytes 当前规则中，被命中的总流量大小  
- target 表示进行的操作  
    - ACCEPT 放行  
    - REJECT 拒绝  
    - DROP 丢弃  
- prot 表示使用的协议（protocol）  
    - TCP  
    - UDP  
    - ICMP  
    - all 为全部协议  
- opt 额外选项说明  
- source 规则针对哪个来源 IP 进行限制  
- destination 规则针对哪个目标 IP 进行限制  
  
- 括号中的 policy 表示默认的策略，如果下面规则都没有满足，则用默认策略  
  
  
## iptables -S 列出特定链上的所有规则  
- `iptables --list-rules [chain]`  
- 不指定链则列出全部链的所有规则  
- 显示格式和 `iptables-save` 格式相同  
  
## iptables-save 查看完整的防火墙规则  
- `*` 开头的指表  
- `:` 开头的指链  
  
```bash  
[root@centos7 ~]$ iptables-save  
# Generated by iptables-save v1.4.21 on Mon May  1 17:59:32 2023  
*filter  
:INPUT ACCEPT [448025:72150829]  
:FORWARD ACCEPT [0:0]  
:OUTPUT ACCEPT [461626:72661106]  
COMMIT  
# Completed on Mon May  1 17:59:32 2023  
```  
  
  
## iptables -nvL --line-numbers 查看规则的编号  
  
  
  
## 清除防火墙规则  
  
> iptables [-t tables] [-F|X|Z|D]  
  
- `-F[chain]` 或 `--flush` Delete all rules in  chain or all chains  
清空指定的链，不指定链则清空全部链  
不删除自定义链，会删除自定义链的规则  
  
- `-X[chain]` 或 `--delete-chain` 删除一个用户自定义的链  
  
- `-Z [chain [rulenum]]` Zero counters in chain or all chains  
iptables 每条规则都有两个计数器：匹配到的报文的个数，以及匹配到的所有报文的大小之和  
即用 `-v` 后看到的 `pkts` 和 `bytes` 两列  
  
- `D` 可以删除某条链上的具体规则  
```bash  
 -D, --delete chain rule-specification  
 -D, --delete chain rulenum  
    Delete one or more rules from the selected chain.  
    There are two versions of this command: the rule can be specified as a number in the chain   
    (starting at 1 for the first rule) or a rule to match.  
```  
```bash  
[root@rocky8-3 ~]$ iptables -nvL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1        0     0 DROP       all  --  *      *       10.0.0.151           0.0.0.0/0  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -t filter -D INPUT 1  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -nvL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
```  
  
  
## 定义默认 policy  
> iptables [-t table] -P chain target  
  
- `-t` 指定表，不指定默认 filter  
- `-P` 后面指定链  
- `target` 指定动作  
    - ACCEPT 接受包  
    - DROP 丢弃包，不会让 client 知道为何被丢弃  
  
## 制定规则  
- 规则要添加到链上，而链在表中，表不指定时默认为 filter  
- 添加在自定义链上的规则不会自动生效  
  
> iptables [-t table][-A|I|R chain] [-i|o interface-name] [-p protocol]   
> [-s 源IP地址/网络] [-d 目标IP地址/网络] -j target  
  
  
### -A 在最后追加规则  
- 规则的顺序很重要  
  
- 如将 10.0.0.151 的数据包全部丢弃  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -A INPUT -s 10.0.0.151 -j DROP  
  
[root@rocky8-3 ~]$ iptables -S  
-P INPUT ACCEPT  
-P FORWARD ACCEPT  
-P OUTPUT ACCEPT  
-A INPUT -s 10.0.0.151/32 -j DROP  
  
[root@rocky8-3 ~]$ iptables -nvL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1        0     0 DROP       all  --  *      *       10.0.0.151           0.0.0.0/0  
```  
  
### -I 插入规则  
  
- 默认插入到第一条规则前  
- 可以指定编号，插入到该编号前  
  
```bash  
-I, --insert chain [rulenum] rule-specification  
    Insert  one or more rules in the selected chain as the given rule number.  
    So, if the rule number is 1, the rule or rules are inserted at the head of the chain.  
    This is also the default if no rule number is specified.  
```  
  
插入一条规则，进入 lo 接口的数据包都接受  
- `0.0.0.0/0` 表示所有网络  
- 如主机有两张网卡，网卡 `eth1` 为信任设备，则可以将下面 `lo` 改为 `eth1` 让该网卡的数据进出都不受限制  
  
```bash  
[root@rocky8-3 ~]$ ip link  
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000  
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00  
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000  
    link/ether 00:0c:29:98:2a:21 brd ff:ff:ff:ff:ff:ff  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -t filter -I INPUT 1 -i lo -j ACCEPT  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -nvL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1        0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0  
2        7   577 REJECT     all  --  *      *       10.0.0.151           0.0.0.0/0            reject-with icmp-port-unreachable  
```  
  
  
### -R 替换规则  
- 可以指定则编号，替换该编号对应的规则  
  
  
### -i|o 指定进出的网络接口  
- 可以使用通配符 `+`  
- 注意只能用在特定的链上  
- `-i` 只能在 PREROUTING, INPUT, FORWARD 用于数据流入的链上  
- `-o` 只能在 OUTPUT, FORWARD, POSTROUTING 用于数据流出的链上  
  
```bash  
[!] -i, --in-interface name  
    Name of an interface via which a packet was received   
    (only for packets entering the INPUT, FORWARD and PREROUTING chains).  
    When the "!" argument is used before the  interface  name, the sense is inverted.  
    If the interface name ends in a "+", then any interface which begins with this name will match.  
    If this option is omitted, any interface name will match.  
  
[!] -o, --out-interface name  
    Name of an interface via which a packet is going to be sent   
    (for packets entering the FORWARD, OUTPUT and POSTROUTING chains).  
    When the "!"  argument  is  used before  the  interface  name,  the  sense is inverted.  
    If the interface name ends in a "+", then any interface which begins with this name will match.  
    If this option is omitted, any interface name will match.  
```  
  
让一个网段的从 `eth1` 进入的数据包都能进入  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -I INPUT 2 -i eth0 -s 10.0.0.0/24 -j ACCEPT  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -nvL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1        0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0  
2      107  5960 ACCEPT     all  --  eth0   *       10.0.0.0/24          0.0.0.0/0  
3        7   577 REJECT     all  --  *      *       10.0.0.151           0.0.0.0/0            reject-with icmp-port-unreachable  
```  
  
  
### -p 指定协议  
- ` [!] -p, --protocol protocol`  
- 常用协议有 tcp, udp, icmp  
- 可以用 `all` 表示全部协议  
- 可以指明数字  
- 前面加 `!` 表示排除该协议  
- 可以从 `/etc/protocols` 文件中查看全部协议  
- 可以通过 `--sport` 或 `--dport` 指定端口号，可以是连续的端口号，如 `22:25`  
- 指定端口号必须先指定协议 tcp 或 udp  
- 如果协议为 tcp，还可以指定SYN标识，即 `--syn`，来筛选主动连到本机的连接   
  
```bash  
    # /etc/protocols:  
  1 # $Id: protocols,v 1.12 2016/07/08 12:27 ovasik Exp $  
  2 #  
  3 # Internet (IP) protocols  
  4 #  
  5 #   from: @(#)protocols 5.1 (Berkeley) 4/17/89  
  6 #  
  7 # Updated for NetBSD based on RFC 1340, Assigned Numbers (July 1992).  
  8 # Last IANA update included dated 2011-05-03  
  9 #  
 10 # See also http://www.iana.org/assignments/protocol-numbers  
 11  
 12 ip  0   IP      # internet protocol, pseudo protocol number  
 13 hopopt  0   HOPOPT      # hop-by-hop options for ipv6  
 14 icmp    1   ICMP        # internet control message protocol  
 15 igmp    2   IGMP        # internet group management protocol  
 16 ggp 3   GGP     # gateway-gateway protocol  
```  
  
  
将从网络接口 `eht1` 的端口 21 数据包阻挡  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -I INPUT 1 -i eth0 -p tcp --dport 21 -j DROP  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -t filter vnL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1        0     0 DROP       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:21  
2        0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0  
3    10089  510K ACCEPT     all  --  eth0   *       10.0.0.0/24          0.0.0.0/0  
4        7   577 REJECT     all  --  *      *       10.0.0.151           0.0.0.0/0            reject-with icmp-port-unreachable  
```  
  
  
### -s|d 来源|目的 IP/网络  
- 指定的 IP 地址可以为多个不连续的地址，用 `,` 分隔  
- 可以指定网段，IP 地址后加 `/mask`  
- 不指定则表示不受限制  
- `-d` 表示连接本机的 ip，如一个网卡设置多个 ip，可以拒绝客户端访问某个 ip  
- 如果只有一个 ip，可以不用写目标地址，因为到 INPUT 链时已经经过路由判决了  
  
```bash  
 [!] -s, --source address[/mask][,...]  
    Source specification.   
    Address can be either a network name, a hostname, a network IP address (with /mask), or a plain IP address.  
    Hostnames  will  be  resolved once  only,  before  the  rule  is submitted to the kernel.  
    Please note that specifying any name to be resolved with a remote query such as DNS is a really bad idea.   
    The mask can be either an ipv4 network mask (for iptables) or a plain number,   
    specifying the number of 1's at the left side of the network  mask.  
    Thus, an  iptables mask of 24 is equivalent to 255.255.255.0.  
    A "!" argument before the address specification inverts the sense of the address.   
    The flag --src is an alias for this option.  Multiple addresses can be specified,   
    but this will expand to multiple rules (when adding with -A),   
    or will cause multiple rules to be deleted (with -D).  
  
[!] -d, --destination address[/mask][,...]  
    Destination specification.  See the description of the -s (source) flag for a detailed description of the syntax.  
    The flag --dst is an alias for this option.  
```  
  
### -j 指明动作  
- ACCPET   
接受  
- DROP   
丢弃  
- REJECT  
拒绝  
- RETURN  
> [11.15. RETURN target](https://www.linuxtopia.org/Linux_Firewall_iptables/x4604.html)  
  
一般用于自定义链中，在当前链中不再继续匹配，返回到主链后继续向后匹配  
- REDIRECT  
重定向端口，NAT 转换时同时修改端口  
因为客户端的端口是动态随机分配的，可能会重复，因此转换时将端口重定向为不重复的新的值  
只能用于 nat 表的 PREROUTING 和 POSTROUTING 链  
NAPT（Network Address and Port Translation）  
- LOG  
记录日志  
rocky8 中记录到 `/var/log/message` 中  
`--log-prefix` 可以指明日志记录的前缀  
- MARK  
做防火墙标记  
- DNAT  
目标地址转换  
- SNAT  
源地址转换  
- MASQUERADE  
地址伪装，例如 nat 表中需要对 ip 进行伪装转换  
  
## iptables -N|E 添加|重命名 自定义链  
- 定义自定义链，可以将多个规则写到一个自定义链中  
- 可以将规则分组，便于重复调用  
- 类似自定义接口函数使用  
  
- 自定义链必须关联到内置的 5 链上才能使用  
- 自定义的操作和内置链相同  
- `iptables -F` 不会删除自定义链，会删除自定义链中的规则  
  
### -N 添加自定义链  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -N cus_chain  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -vnL  
Chain INPUT (policy ACCEPT 22678 packets, 2003K bytes)  
pkts bytes target prot opt in out source destination  
  
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)  
pkts bytes target prot opt in out source destination  
  
Chain OUTPUT (policy ACCEPT 41329 packets, 4283K bytes)  
pkts bytes target prot opt in out source destination  
  
Chain cus_chain (0 references)  
pkts bytes target prot opt in out source destination  
```  
  
- 将自定义链与内置链关联  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -A CUS_CHAIN -s 10.0.0.1 -j ACCEPT  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -t filter -A INPUT -s 10.0.0.0/24 -j CUS_CHAIN  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -vnL  
Chain INPUT (policy ACCEPT 24767 packets, 2112K bytes)  
pkts bytes target prot opt in out source destination  
111  6168 CUS_CHAIN  all  --  * * 10.0.0.0/24 0.0.0.0/0  
  
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)  
pkts bytes target prot opt in out source destination  
  
Chain OUTPUT (policy ACCEPT 44996 packets, 4665K bytes)  
pkts bytes target prot opt in out source destination  
  
Chain CUS_CHAIN (1 references)  
pkts bytes target prot opt in out source destination  
111  6168 ACCEPT     all  --  *      *       10.0.0.1             0.0.0.0/0  
```  
  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -A CUS_CHAIN -s 10.0.0.151 -j REJECT  
[root@rocky8-3 ~]$ iptables -t filter -A INPUT -j REJECT  
```  
  
### -E 自定义链重命名  
- 先写旧名字，再写新名字  
  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -E cus_chain CUS_CHAIN  
[root@rocky8-3 ~]$ iptables -L  
Chain INPUT (policy ACCEPT)  
target     prot opt source               destination  
  
Chain FORWARD (policy ACCEPT)  
target     prot opt source               destination  
  
Chain OUTPUT (policy ACCEPT)  
target     prot opt source               destination  
  
Chain CUS_CHAIN (0 references)  
target     prot opt source               destination  
```  
  
  
### -X 删除自定义链  
- 只有自定义链中无规则且没有其他链关联才能删除该链  
  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -X CUS_CHAIN  
iptables v1.8.4 (nf_tables):  CHAIN_USER_DEL failed (Device or resource busy): chain CUS_CHAIN  
[root@rocky8-3 ~]$ iptables -L  
Chain INPUT (policy ACCEPT)  
target     prot opt source               destination  
CUS_CHAIN  all  --  10.0.0.0/24          anywhere  
  
Chain FORWARD (policy ACCEPT)  
target     prot opt source               destination  
  
Chain OUTPUT (policy ACCEPT)  
target     prot opt source               destination  
  
Chain CUS_CHAIN (1 references)  
target     prot opt source               destination  
ACCEPT     all  --  10.0.0.1             anywhere  
```  
  
- `-F` 删除自定义链的规则  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -F CUS_CHAIN  
[root@rocky8-3 ~]$ iptables -L  
Chain INPUT (policy ACCEPT)  
target     prot opt source               destination  
CUS_CHAIN  all  --  10.0.0.0/24          anywhere  
  
Chain FORWARD (policy ACCEPT)  
target     prot opt source               destination  
  
Chain OUTPUT (policy ACCEPT)  
target     prot opt source               destination  
  
Chain CUS_CHAIN (1 references)  
target     prot opt source               destination  
```  
  
- 自定义链无规则，但与 INPUT 链关联不能删除  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -X CUS_CHAIN  
iptables v1.8.4 (nf_tables):  CHAIN_USER_DEL failed (Device or resource busy): chain CUS_CHAIN  
[root@rocky8-3 ~]$ iptables -L  
Chain INPUT (policy ACCEPT)  
target     prot opt source               destination  
CUS_CHAIN  all  --  10.0.0.0/24          anywhere  
  
Chain FORWARD (policy ACCEPT)  
target     prot opt source               destination  
  
Chain OUTPUT (policy ACCEPT)  
target     prot opt source               destination  
  
Chain CUS_CHAIN (1 references)  
target     prot opt source               destination  
```  
  
- 删除 INPUT 链中自定义链的规则后能删除自定义链  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -D INPUT 1  
[root@rocky8-3 ~]$ iptables -L  
Chain INPUT (policy ACCEPT)  
target     prot opt source               destination  
  
Chain FORWARD (policy ACCEPT)  
target     prot opt source               destination  
  
Chain OUTPUT (policy ACCEPT)  
target     prot opt source               destination  
  
Chain CUS_CHAIN (0 references)  
target     prot opt source               destination  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -t filter -X CUS_CHAIN  
[root@rocky8-3 ~]$ iptables -L  
Chain INPUT (policy ACCEPT)  
target     prot opt source               destination  
  
Chain FORWARD (policy ACCEPT)  
target     prot opt source               destination  
  
Chain OUTPUT (policy ACCEPT)  
target     prot opt source               destination  
```  
  
## 白名单与黑名单  
- 白名单  
只指定允许的，其他都不允许  
- 设置规则时注意不要让自己无法连接上（远程）  
例如虚拟机中使用 NAT 模式，则 windows 中有一个 VMnet8 的虚拟交换机，其地址为 10.0.0.1  
设置白名单规则，拒绝 10.0.0.0/24 网段的处了 10.0.0.82 以外的主机时要先允许 10.0.0.1，否则远程无法连接  
```bash  
[root@rocky8-3 ~]$ iptables -vnL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1      168 13928 ACCEPT     all  --  *      *       10.0.0.1             0.0.0.0/0  
2        0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0  
3       12   810 ACCEPT     all  --  *      *       10.0.0.82            0.0.0.0/0  
4      331 47058 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable  
```  
- 黑名单  
只指定不允许的，其他都接受  
  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -A INPUT -s 10.0.0.151 -j REJECT  
[root@rocky8-3 ~]$ iptables -t filter -A INPUT -j ACCEPT  
[root@rocky8-3 ~]$ iptables -vnL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1        0     0 REJECT     all  --  *      *       10.0.0.151           0.0.0.0/0            reject-with icmp-port-unreachable  
2       94  5296 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0  
```  
  
## iptables 扩展模块  
- 查看扩展模块  
`libxt_.*so` 的文件为其模块，`so` 为共享对象  
```bash  
[root@rocky8-3 ~]$ rpm -ql iptables | grep -i .so  
```  
  
- 查看帮助  
```bash  
[root@rocky8-3 ~]$ man iptables-extensions  
```  
```bash  
iptables-extensions(8) iptables 1.8.4 iptables-extensions(8)  
  
NAME  
    iptables-extensions — list of extensions in the standard iptables distribution  
SYNOPSIS  
    ip6tables [-m name [module-options...]]  [-j target-name [target-options...]  
    iptables [-m name [module-options...]]  [-j target-name [target-options...]  
```  
  
### 隐式扩展  
- 不需要手动指明模块，自动加载的一些常用模块  
- 如用 `-p` 指定协议时，可以指定 `tcp` 协议，即自动调用该模块  
```bash  
[root@rocky8-3 ~]$ rpm -ql iptables | grep -i tcp.so  
/usr/lib64/xtables/libxt_tcp.so  
```  
  
#### tcp 协议模块  
- 不用指明模块，只用 `-p tcp` 即可  
- 源端口，即客户端用什么端口连接到本机的，`-sport`  
可以写端口号或服务的名字  
可以写端口号范围，如果起始端口号省略，则为 0  
```bash  
[!] --source-port,--sport port[:port]  
        Source port or port range specification.   
        This can either be a service name or a port number.   
        An inclusive range can also be specified, using the format first:last.  
        If the first port is omitted, "0" is assumed;   
        if the last is omitted, "65535" is assumed.  
        The flag --sport is a convenient alias for this option.  
```  
- 目的端口，即连接到本机的什么端口，`-dport`，其他格式规则和源端口相同  
```bash  
[!] --destination-port,--dport port[:port]  
    Destination port or port range specification.  The flag --dport is a convenient alias for this option.  
```  
- tcp 标记位  
`--tcp-flags`  
`mask` 为要检查的标记位，多个标记位可以用逗号 `,` 分隔  
`comp` 表示必须设置的标记位，多个标记用逗号 `,` 分隔  
标记位有: SYN ACK FIN RST URG PSH ALL NONE  
```bash  
[!] --tcp-flags mask comp  
    Match  when the TCP flags are as specified.  
    The first argument mask is the flags which we should examine,   
    written as a comma-separated list,   
    and the second argument comp is a comma-separated list of flags which must be set.  
    Flags are: SYN ACK FIN RST URG PSH ALL NONE.  
    Hence the command iptables -A FORWARD -p tcp --tcp-flags SYN,ACK,FIN,RST SYN  
    will only match packets with the SYN flag set, and the ACK, FIN and RST flags unset.  
```  
- tcp 第一次握手，即客户端发送连接请求的第一个报文，`SYN` 标志位为 1，其余标志位为 0  
简单写法为 `--syn`  
注意不会阻止已经连接的数据包通信，也不会阻止服务端发送连接请求  
只会阻止客户端新的连接  
```bash  
[!] --syn  
    Only match TCP packets with the SYN bit set and the ACK,RST and FIN bits cleared.  
    Such packets are used to request TCP connection initiation;  
    --tcp-flags SYN,RST,ACK,FIN SYN.  
    If the "!" flag precedes the "--syn", the sense of the option is inverted.  
```  
  
- tcp 二次握手  
```bash  
--tcp-flags SYN,RST,ACK,FIN SYN,ACK   
```  
  
- TCP option 字段  
```bash  
[!] --tcp-option number  
        Match if TCP option set.  
```  
  
例如允许 http 服务但拒绝 ssh 服务  
先从 `/etc/services` 中查看 http 和 ssh 的端口和协议  
```bash  
[root@rocky8-3 ~]$ iptables -vnL INPUT --line-numbers  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
num   pkts bytes target     prot opt in     out     source               destination  
1        0     0 ACCEPT     tcp  --  *      *       10.0.0.151           0.0.0.0/0            tcp dpt:80  
2        0     0 REJECT     tcp  --  *      *       10.0.0.151           0.0.0.0/0            tcp dpt:22 reject-with icmp-port-unreachable  
```  
1. 先在本机安装 nginx 和 ssh-server，可查看 httpd 和 sshd 服务已启动，处于监听状态  
httpd 为 80 端口，sshd 监听 22 端口  
```bash  
rpm -qa | grep nginx  
sudo yum install -y nginx  
```  
```bash  
[root@rocky8-3 ~]$ ss -tnlp | tr -s "[[:blank:]]" "\t"  
State   Recv-Q  Send-Q  Local   Address:Port    Peer    Address:PortProcess  
LISTEN  0       128     0.0.0.0:5355    0.0.0.0:*       users:(("systemd-resolve",pid=1016,fd=13))  
LISTEN  0       128     0.0.0.0:22      0.0.0.0:*       users:(("sshd",pid=1096,fd=4))  
LISTEN  0       5       127.0.0.1:631   0.0.0.0:*       users:(("cupsd",pid=1299,fd=10))  
LISTEN  0       128     127.0.0.1:6010  0.0.0.0:*       users:(("sshd",pid=5485,fd=15))  
LISTEN  0       70      *:33060 *:*     users:(("mysqld",pid=1488,fd=22))  
LISTEN  0       128     *:3306  *:*     users:(("mysqld",pid=1488,fd=34))  
LISTEN  0       128     ::      :5355   ::      :*      users:(("systemd-resolve",pid=1016,fd=15))  
LISTEN  0       128     *:80    *:*     users:(("httpd",pid=1373,fd=4),("httpd",pid=1365,fd=4),("httpd",pid=1355,fd=4),("httpd",pid=1185,fd=4))  
LISTEN  0       128     ::      :22     ::      :*      users:(("sshd",pid=1096,fd=6))  
LISTEN  0       5       ::1     :631    ::      :*      users:(("cupsd",pid=1299,fd=9))  
LISTEN  0       128     ::1     :6010   ::      :*      users:(("sshd",pid=5485,fd=14))  
```  
  
2. 限制的客户端测试  
- curl 测试能否连接服务器的 80 端口  
```bash  
[root@ubunut22:~]$ curl 10.0.0.83 | head -n 5  
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current  
                                 Dload  Upload   Total   Spent    Left  Speed  
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0<!doctype html>  
<html>  
  <head>  
    <meta charset='utf-8'>  
    <meta name='viewport' content='width=device-width, initial-scale=1'>  
100  7620  100  7620    0     0   709k      0 --:--:-- --:--:-- --:--:--  744k  
```  
- ssh 测试能否连接服务器 22 端口  
```bash  
[root@ubunut22:~]$ ssh root@10.0.0.83  
ssh: connect to host 10.0.0.83 port 22: Connection refused  
```  
  
  
#### udp 扩展模块  
- 同 tcp 一样使用匹配源端口和目标端口  
  
#### icmp 扩展模块  
- `-p icmp`，针对 IPv4  
- `--icmp-type 0/0` 为 icmp 应答  
- `--icmp-type 8/0` 为 icmp 请求  
```bash  
icmp (IPv4-specific)  
This extension can be used if `--protocol icmp' is specified.   
It provides the following option:  
[!] --icmp-type {type[/code]|typename}  
This allows specification of the ICMP type, which can be a numeric ICMP type,   
type/code pair, or one of the ICMP type names shown by the command iptables -p icmp -h  
```  
  
### 显示扩展模块  
- 显示扩展使用需要 `-m` 指定模块名  
- 模块名可以不用写前面的 `libxt_`，如 `-m multiport`  
  
#### multiport  
- 指定端口时可以使用不连续的端口，默认只能用区间写连续的端口  
- `[!] --sports`  
- `[!] --dports`  
- `[!] --ports`   
Match if either the source or destination ports are equal to one of the given ports.  
  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -A INPUT -s 10.0.0.151 -p tcp -m multiport --dports 22:25,80 -j REJECT  
```  
  
  
#### iprange  
- 指定 ip 范围而非一整个网段，更灵活  
- 默认也可以指定多个 ip，用逗号分隔，要一个一个写  
```bash  
iprange  
    This matches on a given arbitrary range of IP addresses.  
    [!] --src-range from[-to]  
        Match source IP in the specified range.  
  
    [!] --dst-range from[-to]  
        Match destination IP in the specified range.  
```  
  
  
#### mac  
- 指明来源 mac 地址  
- 无指定目的 mac 的选项  
- 只能特定链设置  
  
```bash  
[!] --mac-source address  
    Match  source  MAC  address.  
    It must be of the form XX:XX:XX:XX:XX:XX.  
    Note that this only makes sense for packets coming from an Ethernet device and entering  
    the PREROUTING, FORWARD or INPUT chains.  
```  
  
#### string  
- 对应用层数据做字符串模式匹配  
- 如屏蔽某些敏感词  
- `--algo` 可以指定算法，用 `kmp`，用 `bm` 可能有问题  
- `--from` 指定筛选时开始的位置，默认 0，即从头开始查找  
- `--to` 指定结束的偏移位置  
  
```bash  
string  
    This modules matches a given string by using some pattern matching strategy.   
    It requires a linux kernel >= 2.6.14.  
  
    --algo {bm|kmp}  
            Select the pattern matching strategy. (bm = Boyer-Moore, kmp = Knuth-Pratt-Morris)  
  
    --from offset  
            Set the offset from which it starts looking for any matching. If not passed, default is 0.  
  
    --to offset  
            Set  the  offset  up to which should be scanned.   
            That is, byte offset-1 (counting from 0) is the last one that is scanned.  
            If not passed, default is the packet size.  
  
    [!] --string pattern  
            Matches the given pattern.  
  
    [!] --hex-string pattern  
            Matches the given pattern in hex notation.  
  
    --icase  
            Ignore case when searching.  
```  
  
例如设置出去规则，出去网页内容中带有 `death` 关键字则禁止  
注意这里的链为 `OUTPUT` 非 `INPUT `  
指定端口为源端口，因为此时是数据包出去的链，源是本机，目的端口是客户端  
```bash  
[root@rocky8-3 ~]$ iptables -t filter -A OUTPUT -s 10.0.0.151 -p tcp --sport 80 -m string --algo kmp --from 62 --string "death" -j REJECT  
```  
  
#### time  
- 筛选报文到达的时间  
- 时间默认是 UTC 时间，需要转换  
- Centos8 有问题，centos7 可以用  
  
  
#### connlimit   
- 对客户端的 IP 做并发连接数限制  
  
```bash  
--connlimit-upto n  
    Match if the number of existing connections is below or equal n.  
    --connlimit-above n  
    Match if the number of existing connections is above n.  
```  
  
限制并发数不能超过 10  
```bash  
[root@rocky8-3 html]$ iptables -t filter -A INPUT -m connlimit --connlimit-above 10 -j REJECT  
```  
  
客户端用 ab 工具测试  
  
  
```bash  
[root@ubunut22:~]$ ab -n 100000 -c 100 http://10.0.0.83/  
This is ApacheBench, Version 2.3 <$Revision: 1879490 $>  
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/  
Licensed to The Apache Software Foundation, http://www.apache.org/  
  
Benchmarking 10.0.0.83 (be patient)  
apr_socket_recv: Connection refused (111)  
Total of 1 requests completed  
```  
  
  
#### limit   
- 可以指定某段时间内的最大连接数  
- `--limit-burst number` 前多个包不限制，默认 5  
- `--limit rate[/second|/minute|/hour|/day]` 限制速率，默认 3/hour  
    
  
例如限制 icmp 连接请求，前 2 个连接不限制，之后 10/min  
默认 ping 每秒发送一个连接请求  
因此，大于 2 个连接的请求每 6 秒才能连接一个  
  
```bash  
[root@rocky8-3 html]$ iptables -t filter -A INPUT -s 10.0.0.151 -p icmp --icmp-type 8 -m limit --limit 10/minute --limit-burst 2 -j ACCEPT  
[root@rocky8-3 html]$  
[root@rocky8-3 html]$ iptables -t filter -A INPUT -p icmp -j REJECT  
[root@rocky8-3 html]$  
[root@rocky8-3 html]$ iptables -t filter vnL INPUT  
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)  
 pkts bytes target     prot opt in     out     source               destination  
    0     0 ACCEPT     icmp --  *      *       10.0.0.151           0.0.0.0/0            icmptype 8 limit: avg 10/min burst 2  
    7   588 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable  
```  
  
客户端查看，前连个不限制，后面 6 个包只用一个被接受  
```bash  
[root@ubunut22:~]$ ping 10.0.0.83  
PING 10.0.0.83 (10.0.0.83) 56(84) bytes of data.  
64 bytes from 10.0.0.83: icmp_seq=1 ttl=64 time=0.733 ms  
64 bytes from 10.0.0.83: icmp_seq=2 ttl=64 time=0.539 ms  
From 10.0.0.83 icmp_seq=3 Destination Port Unreachable  
From 10.0.0.83 icmp_seq=4 Destination Port Unreachable  
From 10.0.0.83 icmp_seq=5 Destination Port Unreachable  
From 10.0.0.83 icmp_seq=6 Destination Port Unreachable  
64 bytes from 10.0.0.83: icmp_seq=7 ttl=64 time=0.537 ms  
From 10.0.0.83 icmp_seq=8 Destination Port Unreachable  
From 10.0.0.83 icmp_seq=9 Destination Port Unreachable  
From 10.0.0.83 icmp_seq=10 Destination Port Unreachable  
From 10.0.0.83 icmp_seq=11 Destination Port Unreachable  
From 10.0.0.83 icmp_seq=12 Destination Port Unreachable  
64 bytes from 10.0.0.83: icmp_seq=13 ttl=64 time=0.860 ms  
```  
  
#### state  
- 根据数据包的状态进行限制  
- 如对已经建立的连接放行，对新的连接拒绝或丢弃  
- 这里的连接并非限制 tcp 的连接，不是 tcp 连接的状态，而是通用的连接状态  
  
- `--state STATE`  
状态有：INVALID, ESTABLISHED, NEW, RELATED or UNTRACKED  
- NEW 为新的连接，第一次连接，建立后连接追踪库中会为其创建条目，后面就可识别该连接是否新连接  
- ESTABLISHED 连接追踪库为其创建的条目失效前的通信状态，连接追踪库中记录的条目有限制  
- RELATED 新发起的但与已有连相关联的连接，如有些连接建立后会开启一些额外的连接  
- INVALID 无效的连接  
- UNTRACKED 为进行追踪的连接，如 raw 表中关闭追踪  
  
  
如对已经建立的连接放行，对新的连接拒绝或丢弃  
需要先将已建立的连接放行，再对新的连接拒绝  
直接只写对新的连接拒绝，则已建立的连接也会被拒绝  
```bash  
[root@rocky8-3 ~]$ iptables -t filter t filter -A INPUT -m state --state  ESTABLISHED -j ACCEPT  
[root@rocky8-3 ~]$ iptables iptables -t filter -A INPUT -m state --state RELATED -j ACCEPT  
[root@rocky8-3 ~]$  
[root@rocky8-3 ~]$ iptables -t filter -A INPUT -m state --state NEW -j REJECT  
```  
  
##### 连接追踪需要加载的模块  
- 需要加载 nf_conntrack 模块才会启用连接追踪  
- `lsmod` 可以查看内核加载的模块  
```bash  
[root@rocky8-3 netfilter]$ lsmod | grep nf_  
nf_conncount           16384  1 xt_connlimit  
nf_conntrack          172032  4 xt_conntrack,xt_state,nf_conncount,xt_connlimit  
nf_defrag_ipv6         20480  1 nf_conntrack  
nf_defrag_ipv4         16384  1 nf_conntrack  
nf_reject_ipv4         16384  1 ipt_REJECT  
nf_tables             180224  3 nft_compat,nft_counter,nft_limit  
nfnetlink              16384  2 nft_compat,nf_tables  
libcrc32c              16384  3 nf_conntrack,nf_tables,xfs  
```  
  
##### 查看连接追踪的信息库  
启用连接追踪后，会自动生成此模块  
```bash  
[root@rocky8-3 ~]$ cat /proc/net/nf_conntrack  
ipv4  2 tcp 6 299 ESTABLISHED src=10.0.0.83 dst=10.0.0.1 sport=22 dport=58353 \  
src=10.0.0.1 dst=10.0.0.83 sport=58353 dport=22 [ASSURED] mark=0 zone=0 use=2  
```  
  
##### 查看连接追踪的最大记录条目  
```bash  
[root@rocky8-3 ~]$ cat /proc/sys/net/netfilter/nf_conntrack_max  
65536  
```  
  
##### 查看当前已追踪连接数目  
```bash  
[root@rocky8-3 ~]$ cat /proc/sys/net/netfilter/nf_conntrack_count  
1  
```  
  
##### 查看不同协议的连接追踪时长  
- 到达指定的时长后清理记录  
```bash  
[root@rocky8-3 ~]$ cd /proc/sys/net/netfilter/  
[root@rocky8-3 netfilter]$ ls  
nf_conntrack_acct                   nf_conntrack_helper                          nf_conntrack_tcp_timeout_close_wait  
nf_conntrack_buckets                nf_conntrack_icmp_timeout                    nf_conntrack_tcp_timeout_established  
nf_conntrack_checksum               nf_conntrack_icmpv6_timeout                  nf_conntrack_tcp_timeout_fin_wait  
nf_conntrack_count                  nf_conntrack_log_invalid                     nf_conntrack_tcp_timeout_last_ack  
nf_conntrack_dccp_loose             nf_conntrack_max                             nf_conntrack_tcp_timeout_max_retrans  
nf_conntrack_dccp_timeout_closereq  nf_conntrack_sctp_timeout_closed             nf_conntrack_tcp_timeout_syn_recv  
nf_conntrack_dccp_timeout_closing   nf_conntrack_sctp_timeout_cookie_echoed      nf_conntrack_tcp_timeout_syn_sent  
nf_conntrack_dccp_timeout_open      nf_conntrack_sctp_timeout_cookie_wait        nf_conntrack_tcp_timeout_time_wait  
nf_conntrack_dccp_timeout_partopen  nf_conntrack_sctp_timeout_established        nf_conntrack_tcp_timeout_unacknowledged  
nf_conntrack_dccp_timeout_request   nf_conntrack_sctp_timeout_heartbeat_acked    nf_conntrack_timestamp  
nf_conntrack_dccp_timeout_respond   nf_conntrack_sctp_timeout_heartbeat_sent     nf_conntrack_udp_timeout  
nf_conntrack_dccp_timeout_timewait  nf_conntrack_sctp_timeout_shutdown_ack_sent  nf_conntrack_udp_timeout_stream  
nf_conntrack_events                 nf_conntrack_sctp_timeout_shutdown_recd      nf_flowtable_tcp_timeout  
nf_conntrack_expect_max             nf_conntrack_sctp_timeout_shutdown_sent      nf_flowtable_udp_timeout  
nf_conntrack_frag6_high_thresh      nf_conntrack_tcp_be_liberal                  nf_log  
nf_conntrack_frag6_low_thresh       nf_conntrack_tcp_loose                       nf_log_all_netns  
nf_conntrack_frag6_timeout          nf_conntrack_tcp_max_retrans  
nf_conntrack_generic_timeout        nf_conntrack_tcp_timeout_close  
```  
  
  
##### 连接过多解决  
1. 如果修改连接追踪的最大记录数为 1  
```bash  
[root@rocky8-3 netfilter]$ echo 1 > /proc/sys/net/netfilter/nf_conntrack_max  
```  
2. 观察日志 `/var/log/message` 可以看到错误提示  
```bash  
[root@rocky8-3 netfilter]$ tac /var/log/messages | head -n 1  
May  2 16:20:11 rocky8-3 kernel: nf_conntrack: nf_conntrack: table full, dropping packet  
```  
  
解决：  
1. 增大连接数  
不能无限制增加  
`echo 65536 > /proc/sys/net/netfilter/nf_conntrack_max` 的方式修改只能临时生效  
  
- 修改 `/etc/sysctl.conf` 文件使设置永久生效  
    - `net.nf_conntrack_max = 65536`  
    - `net.netfilter.nf_conntrack_max = 65536`  
- sysctl -p 使其生效  
  
  
2. 减小连接记录清理的时间间隔  
不方便，不同协议的时长不同  
  
## 永久保存规则  
1. iptables-save 重定向到一个文件中  
```bash  
[root@rocky8-3 netfilter]$ man iptables-save > rule  
```  
  
2. iptables-restore 恢复文件中的规则  
```bash  
[root@rocky8-3 ~]$ iptables-restore < rule  
```  
  
### 开机自动加载规则文件  
#### 脚本方式  
- 将恢复规则的命令写到 `/etc/rc.d/rc.local` 文件中  
写脚本方式更灵活，可以单独写脚本，然后在开机启动文件中调用脚本  
如写 iptables.allow 和 iptables.deny 脚本分别设置规则  
脚本要加可执行权限，脚本的路径写全，或路径加入 PATH 环境变量  
  
#### rocky8.6 安装 iptables-service  
该工具会加载 `/etc/sysconfig/iptables` 文件中的规则  
自定义规则后可以写到这个文件中  
然后通过 `systemctl` 命令开启该服务  
```bash  
[root@rocky8-3 ~]$ rpm -ql iptables-services  
/etc/sysconfig/ip6tables  
/etc/sysconfig/iptables  
/usr/lib/systemd/system/ip6tables.service  
/usr/lib/systemd/system/iptables.service  
/usr/libexec/initscripts/legacy-actions/ip6tables  
/usr/libexec/initscripts/legacy-actions/ip6tables/panic  
/usr/libexec/initscripts/legacy-actions/ip6tables/save  
/usr/libexec/initscripts/legacy-actions/iptables  
/usr/libexec/initscripts/legacy-actions/iptables/panic  
/usr/libexec/initscripts/legacy-actions/iptables/save  
/usr/libexec/iptables  
/usr/libexec/iptables/ip6tables.init  
/usr/libexec/iptables/iptables.init  
```  
  
默认未开启  
```bash  
[root@rocky8-3 ~]$ systemctl status iptables.service  
● iptables.service - IPv4 firewall with iptables  
   Loaded: loaded (/usr/lib/systemd/system/iptables.service; disabled; vendor preset: disabled)  
   Active: inactive (dead)  
```  
  
#### ubuntu22.04 安装 iptables-persistent  
```bash  
[root@ubuntu2204-c1 ~]$ apt install -y iptables-persistent  
```  
当前已写入的规则自动保存到 `/etc/iptables/rules.v4` 文件中  
  
查看服务状态：  
```bash  
[root@es ~]$ systemctl status netfilter-persistent.service  
```  
  
## IPv4 的内核管理功能 /proc/sys/net/ipv4/*  
> [9.3.5 IPv4 的核心管理功能： /proc/sys/net/ipv4/*](http://cn.linux.vbird.org/linux_server/0250simple_firewall_3.php#netfilter_kernel)  
  
## 规则最优化设置  
- 同类规则，范围小的在前面  
- 不同类的规则，范围大的放在前面，效率更高  
- 安全放行已经建立的连接，最好放第一条  
- 特殊限制的放行规则前拒绝  
  
  
## NAT   
> NAT 原理看 计算机网络-谢希仁-第7版 4.8.2  
> [NAT Explained - Network Address Translation](https://www.youtube.com/watch?v=FTUV0t6JaDA&ab_channel=PowerCertAnimatedVideos)  
  
- network address translation  
- 如局域网中的主机使用私有 IP 地址，当访问互联网时，在出口处将私有 IP 转换为公网 IP 地址与外部通信  
在 vmware 中安装虚拟机时，如果网卡模式选择 NAT 模式，则虚拟机访问外网时，会将虚拟机的私有 IP 地址转换为  
主机，机安装 vmware 的 windows 主机的 IP 地址  
但如果 windows 在一个局域网中，分配的 IP 是私有 IP，则访问公网时仍会转化为公网 IP  
  
在虚拟机中查看访问公网的 IP：  
```bash  
root@Rocky8 ~ $ curl cip.cc  
IP      : 101.88.214.51  
地址    : 中国  上海  
运营商  : 电信  
  
数据二  : 上海市 | 电信  
  
数据三  : 中国上海上海市 | 电信  
  
URL     : http://www.cip.cc/101.88.214.51  
```  
  
NAT 作用  
- 局域网用私有地址，更安全  
- ipv4 地址不够  
  
### SNAT  
- surce NAT 源地址转换  
- 源是相对本机而言  
如内部主机与互联网主机通信时，内部数据包出去时会将内部 IP 转换为公网 IP  
该过程由 POSTROUTING 实现  
  
  
#### --to-source 指定转换的 ip 和端口  
- -j SNAT --to-source [ipaddr[-ipaddr]][:port[-port]] 指定 ip 和 端口  
- 或者 --random 转换为随机的 ip  
  
如在 10.0.0.201 的 NAT 表 POSTROUTING 链上添加 SNAT 规则，当访问 10.0.0.81 的主机时，源地址转换为 10.0.0.220  
  
1. 10.0.0.201 添加规则  
```bash  
[root@ubuntu2204 ~]$ iptables -t nat -A POSTROUTING -s 10.0.0.201 -d 10.0.0.81 -j SNAT --to-source 10.0.0.220  
[root@ubuntu2204 ~]$ iptables -t nat -nvL POSTROUTING  
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)  
 pkts bytes target     prot opt in     out     source               destination  
    0     0 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0  
    0     0 MASQUERADE  all  --  *      !br-850dc0c6265e  172.18.0.0/16        0.0.0.0/0  
    0     0 SNAT       all  --  *      *       10.0.0.201           10.0.0.81            to:10.0.0.220  
```  
  
2. 访问测试  
```bash  
[root@ubuntu2204 ~]$ ping 10.0.0.81  
```  
  
3. 10.0.0.81 上抓包  
```bash  
root@Rocky8 ~ $ tcpdump -i eth0 -nn icmp  
dropped privs to tcpdump  
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode  
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes  
20:27:20.794299 IP 10.0.0.220 > 10.0.0.81: ICMP echo request, id 1, seq 44, length 64  
20:27:21.816441 IP 10.0.0.220 > 10.0.0.81: ICMP echo request, id 1, seq 45, length 64  
```  
可以看到显示来源为 10.0.0.220 而非 10.0.0.201  
  
#### MASQUERADE 实现源地址转换  
- 使用 MASQUERADE 可以从主机网卡自动 ip 而不用自己指定 IP   
- -j MASQUERADE   
- --to-ports port[-port] 指定端口  
- --random 映射为随机端口  
  
```bash  
[root@ubuntu22 ~]$ iptables -t nat -A POSTROUTING -s 10.0.0.201 -d 10.0.0.81 -j MASQUERADE  
```  
  
### DNAT  
- destination NAT 目标地址转换  
- 目标是相对本机  
如果是公网主机发送数据包给内部主机，公网主机知道的是内部主机对外使用的公网 IP，  
数据包到达入口处时，会将此时数据包的目标地址转换为内部主机的私有地址  
  
该过程由 PREROUTING 实现  
  
- -j DNAT  
- -d ExtIP 指定公网可达的 IP 地址，固定的某个 IP  
- --to-destination [ipaddr[-ipaddr]][:port[-port]] 指定转换的 ip 地址和端口，可以为范围  
  
### PNAT   
- port NAT  
- 将 IP 和端口都进行转换   
  
  
### REDIRECT  
- 通过定义规则，可以将收到的数据包转发到同一主机的不同端口  
- 无需开启内核 ip_forward   
  
- -j REDIRECT --to-ports  
  
  
# firewalld  
- 和 iptables 类似，同样命令行工具，管理 netfilter  
- 和 iptables 冲突，只用一个  
